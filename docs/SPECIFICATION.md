# クリスマスビンゴ大会システム 仕様書

## 1. システム概要
本システムは、クリスマスイベント等で使用することを想定した、Webベースのビンゴ抽選システムです。
「ワクワク感」を重視し、リッチな画面演出と効果音を備えています。

## 2. アーキテクチャ
本システムは、関心の分離を意識したレイヤードアーキテクチャを採用しています。

### 全体構成
*   **フロントエンド**: Vue.js (TypeScript)
*   **バックエンド**: Rust (Axum)
*   **通信**: REST API (JSON)

### ディレクトリ構成と責務

#### バックエンド (`backend/`)
ビジネスロジックをフレームワークから分離しています。

*   `src/domain.rs`: **ドメイン層**。ビンゴのルール（数字の管理、抽選ロジック）を純粋なRustコードとして定義。
*   `src/state.rs`: **状態管理**。アプリケーション全体で共有されるメモリ内状態の定義。
*   `src/handlers.rs`: **プレゼンテーション層**。HTTPリクエストを受け取り、ドメインロジックを呼び出してレスポンスを返す。
*   `src/main.rs`: **インフラ層**。サーバーの起動、ルーティング設定。

#### フロントエンド (`frontend/`)
UIコンポーネントとロジック、通信処理を分離しています。

*   `src/components/`: **UIコンポーネント**。表示とユーザー操作の受け付けのみを担当。
    *   `AmidaSetup.vue`: あみだくじの設定（名前入力）フォーム。
    *   `AmidaBoard.vue`: あみだくじの描画、アニメーション、結果表示。
*   `src/composables/`: **アプリケーションロジック**。画面の状態管理や演出の制御。
    *   `useBingoGame.ts`: ビンゴゲームのロジック。
    *   `useAmida.ts`: あみだくじの状態管理（ViewModel）。
    *   `useAmidaGame.ts`: あみだくじの生成・計算ロジック（Domain Logic）。
*   `src/services/`: **インフラストラクチャ**。APIサーバーとの通信処理を隠蔽。
    *   `bingoApi.ts`: ビンゴ関連API。
    *   `amidaApi.ts`: あみだくじ関連API。

## 3. 機能仕様

### 3.1. フロントエンド

#### 画面構成
*   **背景**: クリスマスカラー（緑・赤・金）を基調とし、雪が降るアニメーション (`SnowEffect`) を常時表示。
*   **中央表示**: 現在抽選された数字を大きく表示。
*   **操作パネル**: 「SPIN」ボタンと「RESET」ボタン。
*   **履歴エリア**: 過去に抽選された数字の一覧を表示。
*   **あみだくじ画面**: 景品抽選用のあみだくじ機能。

#### 機能詳細
1.  **抽選 (SPIN)**
    *   「SPIN」ボタン押下で開始。
    *   **演出**: 数字が高速で切り替わるルーレットアニメーション（約3秒間）。徐々に減速する。
    *   **音響**: Web Audio APIを使用。回転中はビープ音、確定時はファンファーレ（和音）を再生。
    *   **サウンド制御**: 画面右下の「Sound: ON/OFF」ボタンで、効果音の有効/無効を切り替え可能。
    *   **結果**: バックエンドから取得した確定数字を表示。

2.  **リセット (RESET)**
    *   「RESET」ボタン押下で確認ダイアログを表示。
    *   承認後、バックエンドの状態を初期化し、画面表示も初期状態（"Merry Christmas!"）に戻す。

3.  **履歴表示**
    *   抽選された数字を即座に履歴リストに追加表示。

4.  **シード値表示**
    *   公平性を担保するため、抽選に使用されている乱数シード値を画面右下に表示。

5.  **あみだくじ (Amidakuji)**
    *   **設定画面 (`/amida`)**: 10個の参加者名（ゲスト名）を入力可能。
        *   1枠の入力が完了したタイミングで、`POST /amida` を呼び出し、サーバーにデータを送信・保存しなければならない。
    *   **ゲーム画面 (`/amida/result`)**:
        *   **遷移条件**: 設定画面で「Start Game」ボタンが押された際、`GET /amida/result` を確認し、有効な結果（10名分のペア）が返ってきた場合のみ遷移する。結果が `None` (未完了) の場合は遷移しない。
        *   `GET /amida/result` でサーバーから抽選結果（参加者と番号のペア）を取得する。
        *   1〜10の番号（景品）が上部にボタンとして表示される。
        *   ボタンをクリックすると、あみだくじのアニメーションが開始され、ゴール地点に対応する参加者名が表示される。
        *   **同時演出**: 最後の2名になった場合、自動的に2つのラインが同時にアニメーションし、結果が同時に表示される。
        *   **サウンド**: ドラムロール（通常）またはティンパニロール（最後）が再生され、結果表示時にシンバル音が鳴る。
        *   **結果の決定**: 誰がどの番号になるかは、サーバーサイドで乱数シードに基づいて決定される。
        *   **あみだくじの線**: クライアント側で毎回ランダムに生成される。サーバーから取得した結果（誰がどの番号か）と整合するように、ゴール地点の参加者配置が調整される。
        *   これにより、ビンゴ同様に結果の再現性と公平性が担保される。

### 3.2. バックエンド

#### データ管理
*   **数字の範囲**: 1 〜 75 (一般的なビンゴのルール)
*   **重複排除**: 抽選された数字はリストから除外され、二度と出現しないことを保証。
*   **ランダム性**: 
    *   外部ファイル (`seeds.txt`) から読み込んだ数値を元にシード値を計算。
    *   XorShiftアルゴリズムを使用して乱数を生成。
    *   これにより、運営による恣意的な操作を排除し、再現性と透明性を確保。
*   **あみだくじデータ**:
    *   参加者名リスト（10名）を保持。
    *   1〜10の番号を内部でシャッフルし、参加者と紐付けることで結果を決定する。

#### 状態保持
*   サーバーのメモリ上で状態（残りの数字、履歴、シード値、あみだくじの状態）を保持する。
*   ※ サーバーを再起動すると状態はリセットされる。

## 4. 技術スタック

### バックエンド
*   **言語**: Rust (Edition 2021)
*   **Webフレームワーク**: Axum 0.7
*   **非同期ランタイム**: Tokio
*   **シリアライズ**: Serde / Serde JSON
*   **乱数生成**: Rand

### フロントエンド
*   **フレームワーク**: Vue.js 3.5 (Composition API)
*   **言語**: TypeScript
*   **ビルドツール**: Vite
*   **音声**: Web Audio API (外部ライブラリ不使用)
